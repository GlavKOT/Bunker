Введение
Актуальность темы
Настольные ролевые игры представляют собой интересную форму досуга, способствующую развитию навыков общения, логического мышления и командной работы. Одной из популярных игр данного жанра является "Бункер". В этой игре участники оказываются в критической ситуации, требующей принятия сложных решений, основанных на характеристиках их персонажей.
Современные технологии позволяют перенести настольные игры в онлайн-формат, делая их доступными большему числу пользователей. Telegram-боты являются удобным инструментом для автоматизации игровых процессов и расширения аудитории игроков. Разработка Telegram-бота, воссоздающего механику игры "Бункер", актуальна, так как позволяет сделать игру доступной в любом месте и в любое время, устраняя необходимость в физическом присутствии игроков.
При этом бот будет полезен не только для онлайн-игры, но и для удобства проведения игры в офлайн-формате. В настольной версии "Бункера" игрокам часто приходится вручную заполнять таблицы, следить за раскрытием характеристик персонажей и соблюдать сложные игровые механики. Telegram-бот значительно упрощает процесс игры, выполняя за игроков рутинные задачи, такие как создание таблиц, генерация персонажей, автоматическое обновление данных и проведение голосований. Это делает игру динамичнее, удобнее и доступнее даже для начинающих участников.
Кроме того, разработка подобных ботов требует знаний в области программирования, работы с API и построения архитектуры серверных приложений. Это делает проект не только интересным с точки зрения игровой механики, но и полезным в образовательном плане.
Цель проекта
Целью проекта является создание Telegram-бота, который позволит пользователям играть в настольную игру "Бункер" в режиме онлайн и упрощать ее проведение в офлайн-формате. Бот должен обеспечивать автоматизацию игрового процесса, управлять очередностью ходов, генерировать персонажей и характеристики, а также проводить голосования среди участников.
Задачи проекта
Для достижения поставленной цели необходимо выполнить следующие задачи:
Изучить принципы работы Telegram API и Java Spring Boot.
Разработать архитектуру бота, обеспечивающую удобное и надежное взаимодействие пользователей с системой.
Реализовать основные игровые механики, включая создание сессий, генерацию персонажей, проведение голосований и исключение игроков.
Обеспечить удобный интерфейс взаимодействия через чат, позволяющий пользователям легко управлять игровым процессом.
Разработать механизмы упрощения офлайн-игры, включая автоматическое составление таблиц, раскрытие характеристик и контроль игровых процессов.
Провести тестирование бота с участием нескольких игроков, выявить возможные ошибки и оптимизировать работу приложения.
Подготовить документацию, описывающую процесс разработки, а также правила использования бота.


Методы и подходы к реализации
Для разработки Telegram-бота используется язык программирования Java с применением фреймворка Spring Boot. Этот выбор обусловлен возможностью удобного масштабирования проекта, а также наличием большого количества готовых инструментов для взаимодействия с API Telegram. Взаимодействие с пользователями будет осуществляться посредством текстовых сообщений и встроенных кнопок, обеспечивающих простоту управления ботом.
Игровая логика бота строится на основе сессионного взаимодействия, где каждому игроку присваиваются случайные характеристики, а игровой процесс организуется в виде череды последовательных действий, направленных на выбор наиболее подходящих кандидатов для выживания в бункере. Голосования, управление ходами и исключение игроков реализуются через механизмы, встроенные в API Telegram.
Помимо онлайн-игры, бот также предназначен для помощи в офлайн-версии "Бункера". Он выполняет такие функции, как автоматическое формирование таблицы с характеристиками игроков, ведение истории событий и управление раскрытием скрытых характеристик персонажей. Это значительно сокращает время на подготовку игры и избавляет ведущего от необходимости вручную контролировать все игровые процессы.
Планируется интеграция механизма хранения данных, который позволит сохранять информацию о текущих игровых сессиях, обеспечивая возможность восстановления игры в случае сбоя или временного отсутствия игрока.
В ходе работы над проектом особое внимание будет уделено тестированию, что позволит гарантировать стабильность работы бота, а также удобство и понятность взаимодействия с ним для пользователей.
Описание используемых библиотек

Spring Boot
Spring Boot – это фреймворк на языке Java, предназначенный для упрощенной разработки веб-приложений и микросервисов. Он обеспечивает удобную настройку, автоматическую конфигурацию и встроенный сервер, что значительно сокращает время разработки. В данном проекте Spring Boot используется для создания REST API, обработки команд пользователей и управления игровыми сессиями.

JSON (Jackson/Gson)
JSON (JavaScript Object Notation) – это легковесный формат обмена данными, широко используемый в веб-разработке. В проекте используется библиотека Jackson (или Gson) для сериализации и десериализации объектов в JSON-формат. Это позволяет хранить и передавать игровые данные, такие как характеристики персонажей и состояния сессий, в удобном и читаемом виде.

Telegram API (TelegramBots)
TelegramBots – это библиотека для взаимодействия с Telegram API в Java. Она позволяет обрабатывать входящие сообщения, отправлять текстовые ответы, управлять кнопками интерфейса и работать с интерактивными элементами. В проекте библиотека используется для создания Telegram-бота, который управляет игровым процессом, отправляет уведомления игрокам и обрабатывает их команды.


Основная часть
Технологии и инструменты
Для разработки бота использовались следующие технологии:
Язык программирования: Java
Фреймворк: Spring Boot
Telegram API: TelegramBots
Формат хранения данных: JSON
Функционал бота
Бот поддерживает:
Создание игровой сессии
Подключение игроков
Генерацию персонажей
Проведение голосований
Автоматизированные игровые события
Упрощение офлайн-игры (автоматическое создание таблиц, управление характеристикам
Он состоит из следующих основных классов:
Bot – основной класс бота, обрабатывающий входящие обновления
Session – класс, управляющий игровой сессией
Player – класс, описывающий игрока и его характеристики
Scene – сценарии и условия игры
Prop – класс для удобного создания характеристик
TableToImage – графический класс, который конвертирует данные сессии в PNG файл с таблицей
Подробнее о классах проекта ниже
public class Bot extends TelegramLongPollingBot {

	Класс реализует основную логику бота Telegram обрабатывая обновления (Update), соответствуя следующей схеме:
	
Проверка на наличия сообщения в обновлении
if (update.hasMessage()) {
	
	Если сообщение соответствует паролю из конфига
-> Закрытие бота
	
	Если в сообщение присутствует “/start” и там больше 1 слова то Игрок заходит в сессию соответствующую UUID из второго слова. Эта логика создана для работы подключения игроков по ссылке.

Если сообщение == “Создать” ->
Создается новая сессия, игрок добавляется в неё и отмечается администратором. Ему отправляется сообщение с UUID сессии, ссылкой-приглашением и QR-кодом

(ПРОСЬБА НЕ СКАНИРОВАТЬ QR-код на скриншоте)

так-же в сообщение присутствует описание сценария игры.

Если сообщение == “Войти” -> Присылается сообщение с текстом “Введите ID формата 123e4567-e89b-12d3-a456-426655440000”
И после ввода пользователем UUID, он добавляется в игру и ему отправляется сценарий. Параллельно с этим администратору сессии обновляется сообщение “Создания”, где указывается список игроков в ожидании.

	Во всех остальных случаях отправляется меню бота с картинкой и кнопками[“Создать”, “Войти”]


}
Проверка на наличие ответа (Нажатой кнопки под сообщением)
if (update.hasCallbackQuery()) {

	
Здесь, как выше сказано, обрабатываются нажатия кнопок. А именно:

Нажатие кнопки начала игры “startGame”
Здесь всем игрокам удаляются старые сообщения, обновляется сценарий.
Определяется ходящий игрок.
Выдаются карточки с характеристиками игрокам.
Обновляется таблица.

Нажатие кнопки с характеристикой
Если сейчас ход игрока -> открывается выбранная характеристика в таблице.
Обновляется таблица у всех игроков.

Нажатие кнопки со способностью
Если способность заключается в изменении характеристики выбранного игрока, пользователю высылается сообщение с кнопками имён игроков.
После выбора, или, если способность заключается в более простом действии, оно выполняется. 


}



	Проверка на наличия ответа в голосовании
if (update.hasPoll()) {
	
	Эта часть кода существует для реализации голосований за выбрасывания игроков, после каждого раунда.
	Останавливается опрос у игрока.
Добавляется голос за вариант игрока в таблицу сессии
Если все проголосовали ->
	Просчитывает варианты с большим количеством голосов и отмечает их выброшенными, открывает все их характеристики в таблице.Обновляет таблицу и игроков


	В случае, если игроков достаточно для победы, то оставшиеся игроки отмечаются победившими. Открывает характеристики всех игроков и обновляет всем таблицу. Также удаляются сообщения с карточками игроков, администратору отправляется сообщение с кнопкой завершения сессии, при ее нажатии удаляются все сообщения у игроков и их данные. После этого просчитывается победа игроков, отправляется результат в соответствии со сценарием.

}}Так-же в классе присутствует пара методов для удобства. Их я рассматривать не буду.
public class Player {

В классе записываются:
Строки с именем, профессией и ее функциями,
Пользователь и его long id,
UUID сессии,
Булы:
stepper - ходит ли,
kicked - выкинут ли,		
winner - победитель ли
polled - голосовал ли,
Карты<String,String> для характеристик и открытых характеристик,
Сообщение с карточкой ]
В нем присутствуют методы:
public static get(long id) и get(User user)
	В случае, если игрок существует, он возвращает его из данных, если игрока не найдено, создает и указывает все необходимые значения на основе User.

public String getFullName()
	Возвращает отформатированное имя игрока в зависимости от различных обстоятельств

public void flush()
	Обновляет игрока в данных бота

public void deleteMessages()
	Удаляет сообщения игроку


public void randomiseProps()
	Выдает пользователю случайную карточку с характеристиками и записывает в данные игрока.
Также в классе присутствуют методы для редактирования и добавления характеристик, которые понятны из названия.
public class Session {
В классе записываются:
UUID id – уникальный идентификатор игровой сессии.
Список List<Long> игроков – идентификаторы пользователей, участвующих в данной сессии.
Map<String, Object> data – хранилище данных о сессии.
Строка state – текущее состояние игры (например, "starting", "in_progress", "finished").
Список List<Message> tableMes – сообщения с таблицами игроков.
Список List<Message> sceneMes – сообщения с описанием сцены.
int step – текущий ход.
int round – текущий раунд.
boolean onPoll – идет ли сейчас голосование.
Map<String, Integer> poll – результаты голосования.
Scene scene – объект текущей сцены.
Player admin – игрок, который создал сессию.
Методы:
public static Session get(UUID id)
Возвращает сессию по ее UUID. Если сессии не существует, возвращает null.
public void addPlayer(Player player)
Добавляет игрока в сессию, записывая его id в список players.


public void next()
Передает ход следующему игроку. Если необходимо, запускает голосование или завершает игру.
public void sendPoll()
Создает и отправляет голосование для исключения одного из игроков.
public void kickPlayer(Player player)
Исключает игрока из сессии, изменяя его статус kicked = true.
public void updateTable()
Обновляет таблицу игроков, отображая их характеристики и статусы.
public boolean hisStep(Player player)
Проверяет, является ли данный игрок тем, кто должен ходить.
public void kill()
Завершает сессию, открывает характеристики выживших и объявляет победителей.
Этот класс управляет всей игровой логикой, определяя ход игры, голосования и победные условия.

public class Prop {
Класс отвечает за генерацию и обработку характеристик персонажей. Он работает с файлами .prop, хранящими возможные значения характеристик, и предоставляет методы для их случайного выбора и редактирования.
Методы:
public static void createFiles()
Создает файлы с характеристиками, если они отсутствуют.
Проверяет наличие каталога с характеристиками (/properties).
Если файлов нет, создает их и записывает базовые значения.
Создает order.txt – файл с перечнем характеристик, определяющий их порядок.
public static int propCount()
Возвращает количество доступных характеристик, проверяя количество .prop файлов в каталоге.
public static List<String> getAllProperties()
Считывает все .prop файлы.
Преобразует их содержимое в список строк, содержащих возможные значения характеристик.
public static List<String> getAllNames()
Читает order.txt.
Возвращает список всех возможных названий характеристик.

public static String random(String propName)
Выбирает случайное значение характеристики.
Читает файл propName.prop.
Загружает список возможных значений.
Генерирует случайное значение, возвращая его.
public static int position(String propName)
Определяет, в каком порядке должна отображаться характеристика.
Читает order.txt.
Возвращает индекс переданной характеристики.
Этот класс управляет хранилищем характеристик, обеспечивая их генерацию и порядок отображения в игре.


public class TableToImage {

Отвечает за генерацию изображения таблицы с характеристиками игроков.

Логика работы методов:

1. convert(Session session) – основной метод генерации изображения таблицы


Подготовка заголовков:
Создается список names с заголовками столбцов (имя и характеристики).
Определяется ширина столбцов на основе длины текста (умножается на 12 и добавляется 35 пикселей для отступов).
Создание таблицы игроков:
Перебираются игроки из session.getPlayers(),
Их характеристики добавляются в table (список строк).
Одновременно корректируются размеры столбцов, чтобы они соответствовали самому длинному значению.
Определение размеров изображения:
Ширина определяется суммой всех cellSizes.
Высота – количеством строк (игроков + заголовок) умноженным на cellHeight (40 пикселей).
Минимальная высота – 320 пикселей.


Создание изображения:
Используется BufferedImage с прозрачностью (TYPE_INT_ARGB).
Включается сглаживание (RenderingHints) для повышения качества.
Фон заливается белым цветом.
Отрисовка заголовков:
Серый фон.
Текст рисуется жирным шрифтом Arial 20px.
Каждому заголовку выделяется отдельная ячейка, ограниченная прямоугольником.
Отрисовка строк с характеристиками игроков:
Шрифт Arial 16px.
Перебираются строки таблицы, каждая записывается в свою ячейку.
Если характеристика содержит ( (например, Врач (Может полностью вылечить любого человека)), то выводится только часть до (.
Последний столбец получает дополнительный отступ.
Выделение исключенных (kicked) и победителей (winner)
Исключенные игроки (player.kicked) – вся строка перечеркивается полупрозрачной красной линией.
Победители (player.winner) – строка заливается полупрозрачным зеленым цветом.
Сохранение изображения в PNG:
Используется ImageIO.write(image, "png", file).
Файл сохраняется как table.png.
Итог
В ходе работы был разработан Telegram-бот, автоматизирующий игровой процесс "Бункера". Бот позволяет проводить игру как в онлайн-режиме, так и упрощать офлайн-версию, выполняя сложные игровые задачи за ведущего. Это делает игру доступной в любом месте, сокращает время на подготовку и делает игровой процесс более удобным. В будущем возможно расширение функционала и добавление новых игровых механик.
